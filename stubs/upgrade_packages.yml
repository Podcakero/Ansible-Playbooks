- name: Update apt repo and cache on Debian Servers
  apt:
      update_cache: yes  
  when:
  - (ansible_facts['distribution'] == "Debian") or (ansible_facts['distribution'] == "Ubuntu")

- name: Upgrade all packages
  package:
      name: "*"
      state: latest

- name: Check if a reboot is needed on Debian Servers
  stat: 
      path: /var/run/reboot-required 
      get_md5: no
  register: reboot_required_file
  when:
  - (ansible_facts['distribution'] == "Debian") or (ansible_facts['distribution'] == "Ubuntu")

- name: Reboot the box if kernel updated on Debian Servers
  reboot:
      msg: "Reboot initiated by Ansible for kernel updates"
      connect_timeout: 5
      reboot_timeout: 300
      pre_reboot_delay: 0
      post_reboot_delay: 30
      test_command: uptime
  when: 
  - (ansible_facts['distribution'] == "Debian") or (ansible_facts['distribution'] == "Ubuntu")
  - reboot_required_file.stat.exists == "True"

- name: Clean and Remove unused packages on Debian Servers
  apt:
      autoclean: yes
      autoremove: yes
      clean: yes
  when: 
  - (ansible_facts['distribution'] == "Debian") or (ansible_facts['distribution'] == "Ubuntu")

- name: Remove unused packages on Rocky Servers
  dnf: 
      autoremove: yes
  when: 
  - ansible_facts['distribution'] == "Rocky"
